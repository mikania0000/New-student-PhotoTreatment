<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é³³ç”²åœ‹ä¸­æ–°ç”Ÿç…§ç‰‡ç®¡ç†ç³»çµ± (GitHubç‰ˆ)</title>
  <!-- å¼•å…¥ Font Awesome åœ–ç¤º -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  
  <style>
    /* ----- å…¨åŸŸæ¨£å¼ ----- */
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 30px 0;
      overflow-x: auto;
      min-width: 1600px;
    }
    
    /* ----- ä¸»å®¹å™¨ ----- */
    .main-container {
      width: 1300px;
      margin: 0 auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 20px;
      position: relative;
    }
    
    /* ----- æ¨™é¡Œ ----- */
    .main-title {
      font-size: 65px;
      font-weight: 900;
      text-align: center;
      background: linear-gradient(90deg, #2196f3, #42a5f5, #bbdefb);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.15);
      margin-bottom: 30px;
      letter-spacing: 2px;
    }

    /* ----- è³‡æ–™å¤¾ç‹€æ…‹æŒ‡ç¤ºç‡ˆ ----- */
    #folder-status {
      text-align: center; 
      margin-top: -15px; 
      margin-bottom: 25px; 
      font-size: 22px; 
      font-weight: bold; 
      color: #555;
    }

    /* ----- è¡¨å–®å€å¡Š ----- */
    .form-row { display: flex; justify-content: space-between; }
    .form-box {
      background: linear-gradient(to bottom right, #e0f7fa, #fffde7);
      padding: 24px;
      border-radius: 14px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: flex;
      flex-direction: column;
      gap: 20px;
      transition: all 0.3s ease;
    }
    .left-form { width: 100%; max-width: 1500px; margin: 0 auto; }
    
    /* ----- è¼¸å…¥æ¬„ä½ç¾¤çµ„ (ç­‰å¯¬ä¿®æ­£) ----- */
    .input-group {
      display: flex; 
      align-items: center; 
      gap: 15px; 
      justify-content: flex-start; 
      padding-left: 100px;
      margin-bottom: 15px;
    }
    .input-group:first-of-type { margin-top: 20px; }
    
    .input-group label {
      width: 130px; 
      text-align: right; 
      font-size: 26px; 
      white-space: nowrap;
      font-weight: bold;
      color: #333;
    }
    
    .input-group select, .input-group input {
      width: 430px; 
      height: 50px;           /* å¼·åˆ¶å›ºå®šé«˜åº¦ */
      font-size: 24px; 
      padding: 5px 12px;      /* çµ±ä¸€å…§è· */
      border: 2px solid #90caf9; 
      border-radius: 8px;
      box-sizing: border-box; /* è®“å…§è·èˆ‡é‚Šæ¡†è¨ˆç®—åœ¨å¯¬åº¦å…§ */
      background-color: #fff;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .input-group select:focus, .input-group input:focus {
      border-color: #2196f3;
      box-shadow: 0 0 8px rgba(33, 150, 243, 0.3);
    }

    /* ----- æŒ‰éˆ•ç¾¤çµ„ ----- */
    .button-group {
      display: flex; flex-wrap: wrap; gap: 12px;
      justify-content: center; margin-top: 20px;
    }
    .btn {
      font-size: 24px; padding: 10px 18px; border: none;
      border-radius: 6px; color: white; cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: transform 0.2s ease;
      display: inline-flex; align-items: center; justify-content: center;
    }
    .btn:hover { transform: scale(1.05); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    
    /* æŒ‰éˆ•é¡è‰² */
    .btn-green { background: linear-gradient(to right, #4CAF50, #66BB6A); }
    .btn-red { background: linear-gradient(to right, #F44336, #EF5350); }
    .btn-blue { background: linear-gradient(to right, #2196F3, #42A5F5); }
    .btn-pink { background: linear-gradient(to right, #EC407A, #F06292); }
    .btn-yellow { background: linear-gradient(to right, #FFEB3B, #FDD835); color: black; }
    .btn-orange { background: linear-gradient(to right, #FF9800, #FFA726); }
    .btn-brown { background: linear-gradient(to right, #795548, #8D6E63); color: white; }
    .btn-purple { background: linear-gradient(to right, #8e24aa, #ba68c8); color: white; }
    .btn-cyan { background: linear-gradient(to right, #00bcd4, #4dd0e1); color: white; }

    /* ----- çµæœé¡¯ç¤ºå€ (ä¿®æ­£åˆ†é æŒ‰éˆ•è·‘ç‰ˆ) ----- */
    .bottom-result {
      width: 100%; 
      display: flex; 
      flex-direction: column; /* å‚ç›´æ’åˆ— */
      align-items: center;    /* æ°´å¹³ç½®ä¸­ */
      margin-top: 30px;
    }

    /* ----- è¨Šæ¯æç¤º ----- */
    .msg {
      font-size: 26px; color: white; padding: 12px 20px;
      border-radius: 6px; position: fixed;
      top: 50%; left: 50%; transform: translate(-50%, -50%);
      z-index: 2000; display: none; text-align: center;
      white-space: pre-line; max-width: 90%; word-break: break-word;
    }
    .msg-error { background: #d32f2f; }
    .msg-success { background: #388e3c; }
    .msg-info { background: #1976d2; }
    .msg-progress { background: #ec407a; }

    /* ----- è¡¨æ ¼æ¨£å¼ ----- */
    table { width: 100%; border-collapse: collapse; font-size: 18px; text-align: center; background-color: #e3f2fd; border: 2px solid #90caf9; }
    thead { background-color: #1976d2; color: white; font-size: 20px; }
    tbody tr:nth-child(even) { background-color: #f1f8ff; }
    tbody tr:nth-child(odd) { background-color: #e3f2fd; }
    th, td { padding: 10px; border: 1px solid #90caf9; }

    /* è¡¨æ ¼å…§æŒ‰éˆ• */
    .modify-btn { background-color: #fdd835; color: black; border: none; padding: 6px 14px; border-radius: 8px; cursor: pointer; font-weight: bold; }
    .delete-btn { background-color: #e53935; color: white; border: none; padding: 6px 14px; border-radius: 8px; cursor: pointer; font-weight: bold; }
    .cancel-btn { background-color: #f48fb1; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; font-size: 18px; }

    /* ----- çµ±è¨ˆç›’å­ (å³ä¸Šè§’) ----- */
    .stats-box {
      position: absolute; 
      top: 290px; 
      right: 280px; 
      width: 340px;
      background: linear-gradient(to bottom right, #fff9c4, #fffde7);
      border-left: 10px solid #fbc02d; border-radius: 20px;
      box-shadow: 4px 4px 18px rgba(0, 0, 0, 0.18);
      padding: 24px 28px 20px 28px; font-size: 24px; color: #4e342e; z-index: 1000;
    }
    .stats-box h3 {
      font-size: 32px; color: #e65100; margin: 5px 0 16px 0;
      padding-bottom: 6px; font-weight: bold;
      border-bottom: 2px solid #fbc02d; text-align: center;
    }
    .stats-box ul { list-style: none; padding-left: 0; margin: 0; }
    .stats-box li {
      font-size: 24px; margin-bottom: 2px; padding: 6px 10px; border-radius: 8px; line-height: 1.0;
    }
    .stats-box li:nth-child(even) { background-color: #fff8e1; }
    .stats-box li:nth-child(odd) { background-color: #fffde7; }

    /* ----- é€²éšè¨­å®šå€ ----- */
    #advanced-settings {
      max-width: 800px; margin: 30px auto; padding: 20px;
      background: #fbe9f7; border-radius: 12px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .advanced-btn {
      min-width: 150px; width: 180px; height: 56px; margin: 0;
      padding: 0 8px; font-size: 20px; font-weight: bold; border-radius: 12px;
      display: flex; align-items: center; justify-content: center; white-space: nowrap;
    }

    /* ----- Modal (é€šç”¨é®ç½©) ----- */
    .modal-mask {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.4); z-index: 10001; display: none;
    }
    .modal-dialog {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%); background: #fff;
      border-radius: 16px; box-shadow: 0 8px 36px rgba(0,0,0,0.2);
      padding: 28px 32px; min-width: 270px; text-align: center;
    }
    
    /* ----- è²¼ä¸ŠåŒ¯å…¥ Modal ç‰¹åˆ¥æ¨£å¼ ----- */
    #paste-modal-dialog {
      width: 800px; max-width: 90%;
      max-height: 85vh;            /* âœ… æ–°å¢ï¼šæœ€å¤§é«˜åº¦é™åˆ¶ï¼Œé˜²æ­¢è¶…å‡ºè¢å¹• */
      display: flex;               /* âœ… æ–°å¢ï¼šä½¿ç”¨ Flexbox ä½ˆå±€ */
      flex-direction: column;      /* âœ… æ–°å¢ï¼šå‚ç›´æ’åˆ— */
      border: 3px solid #2196f3;
    }
    #paste-textarea {
      width: 100%; 
      flex: 1;                     /* âœ… æ–°å¢ï¼šè‡ªå‹•å¡«æ»¿å‰©é¤˜é«˜åº¦ */
      min-height: 150px;           /* âœ… æ–°å¢ï¼šè¨­å®šæœ€å°é«˜åº¦ */
      font-size: 16px; padding: 10px; border: 1px solid #ccc; border-radius: 8px;
      margin-top: 10px; margin-bottom: 20px; font-family: monospace;
      resize: none;                /* âœ… ä¿®æ”¹ï¼šç”± Flex è‡ªå‹•åˆ†é…é«˜åº¦ï¼Œç¦æ­¢æ‰‹å‹•æ‹‰æ”¾ */
      white-space: pre; overflow-x: auto;
    }

    @media screen and (max-width: 1700px) {
      .main-container { width: 95%; }
    }
  </style>

  <script>
    // âœ… è¨­å®š Google Apps Script éƒ¨ç½²ç¶²å€ (Deploy ID)
    const DEPLOY_ID = 'AKfycbxyj4HI3ZyvXnSrZechSG7ODYSeyLFusBWLIfp7Ezoh435chugb-2Xr7doTUpgj-WfclA';
    const GAS_URL = `https://script.google.com/macros/s/${DEPLOY_ID}/exec`;

    // âœ… é€šç”¨ API å‘¼å«å‡½å¼ (å–ä»£ google.script.run)
    async function callApi(action, data = {}) {
      try {
        const payload = { action: action, data: data };
        
        // âš ï¸ ä½¿ç”¨ POST ç™¼é€
        const response = await fetch(GAS_URL, {
          method: 'POST',
          body: JSON.stringify(payload) 
        });
        
        const json = await response.json();
        
        if (json.status === 'success') {
          return json.data;
        } else {
          throw new Error(json.message || 'æœªçŸ¥éŒ¯èª¤');
        }
      } catch (e) {
        console.error("API Error:", e);
        showMessage('é€£ç·šéŒ¯èª¤: ' + e.message, 'error', 5);
        throw e;
      }
    }
  </script>
</head>
<body>
  <div class="main-container">
    <h1 class="main-title">é³³ç”²åœ‹ä¸­æ–°ç”Ÿç…§ç‰‡ç®¡ç†ç³»çµ±</h1>
    
    <!-- ğŸ†• è³‡æ–™å¤¾ç‹€æ…‹æŒ‡ç¤ºç‡ˆ -->
    <div id="folder-status">
      ğŸ“ ç…§ç‰‡è³‡æ–™å¤¾ç‹€æ…‹ï¼š<span id="folder-light" style="background: #e0e0e0; padding: 4px 12px; border-radius: 20px;">âšª æª¢æŸ¥ä¸­...</span>
    </div>

    <div class="form-row">
      <div class="form-box left-form">
        <!-- æŸ¥è©¢æ¢ä»¶å€ -->
        <div class="input-group">
          <label for="grade">å¹´ç´š</label>
          <select id="grade">
            <option value="" selected></option>
            <option value="7">7</option>
            <option value="8">8</option>
            <option value="9">9</option>
          </select>
        </div>
        <div class="input-group">
          <label for="class">ç­ç´š</label>
          <select id="class"></select>
        </div>
        <div class="input-group">
          <label for="seat">åº§è™Ÿ</label>
          <select id="seat"></select>
        </div>
        <div class="input-group">
          <label for="name">å§“å</label>
          <input id="name" type="text">
        </div>
        <div class="input-group">
          <label for="sid">å­¸è™Ÿ</label>
          <input id="sid" type="text">
        </div>
        <div class="input-group">
          <label for="repeat">é‡è¤‡ä¸Šå‚³</label>
          <select id="repeat">
            <option value=""></option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4+">4æ¬¡ä»¥ä¸Š</option>
          </select>
        </div>
        <div class="input-group">
          <label for="status">è™•ç†æƒ…å½¢</label>
          <select id="status">
            <option value=""> </option>
            <option value="å·²ä¸Šå‚³ï¼Œåˆæ ¼">åˆæ ¼</option>
            <option value="ä¸åˆæ ¼">ä¸åˆæ ¼</option>
            <option value="å¯©æ ¸ä¸­">å¯©æ ¸ä¸­</option>
          </select>
        </div>
        
        <!-- å³å´çµ±è¨ˆè³‡æ–™ (æ¼‚æµ®) -->
        <div class="stats-box" id="summary-content">
          <h3>ğŸ“¸ <span>ç…§ç‰‡è™•ç†çµ±è¨ˆè¡¨</span></h3>
          <div>â³ è¼‰å…¥ä¸­...</div>
        </div>

        <!-- åŠŸèƒ½æŒ‰éˆ•å€ -->
        <div class="button-group">
          <button class="btn btn-green" onclick="handleQuery()">æŸ¥è©¢</button>
          <button class="btn btn-red" onclick="handleClear()">æ¸…é™¤</button>
          <button class="btn btn-blue" onclick="handleUnsubmitted()">æœªä¸Šå‚³</button>
          <button class="btn btn-brown" onclick="showStatsTable()">
            <i class="fas fa-chart-bar"></i> ç­ç´šçµ±è¨ˆè¡¨
          </button>
          <button class="btn btn-yellow" onclick="window.open('https://mikania0000.github.io/New-student-PhotoRemoveBack/')">å»èƒŒç¶²é </button>
          <button class="btn btn-orange" onclick="window.open('https://mikania0000.github.io/New-student-PhotoUpload/')">ç…§ç‰‡ä¸Šå‚³ç¶²é </button>
          <button class="btn btn-pink" onclick="window.open('https://mikania0000.github.io/New-student-ParentQuery/')">ç·¨ç­æŸ¥è©¢ç¶²é </button>
          <button class="btn btn-purple" onclick="showAdvancedSettings()">é€²éšè¨­å®š</button>
        </div>

        <!-- æŸ¥è©¢çµæœé¡¯ç¤ºå€ -->
        <div class="bottom-result" id="result-container"></div>
      </div>
    </div>

    <!-- ç­ç´šçµ±è¨ˆè¡¨é¡¯ç¤ºå€ -->
    <div class="bottom-result" id="stats-container"></div>

    <!-- é€²éšè¨­å®šå€ (é è¨­éš±è—) -->
    <div id="advanced-settings" style="display:none; text-align:center;">
      <h2 style="font-size:36px; color:#6a1b9a; margin-bottom:20px; text-shadow:1px 1px 3px rgba(0,0,0,0.2);">
        âš™ï¸ é€²éšè¨­å®šé¸å–®
      </h2>
      <div style="display:flex; flex-wrap:wrap; justify-content:center; gap:16px; margin-bottom:25px; background:#f3e5f5; padding:20px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
        <button class="btn btn-purple advanced-btn" onclick="window.open('https://docs.google.com/spreadsheets/d/1-iIXTbEeIqzaMnWQowqyvOquqZQLJpnRCUST-mVZ1Tw/edit?gid=1164346300#gid=1164346300')">ğŸ“„åŸå§‹å·¥ä½œè¡¨</button>
        <button class="btn btn-green advanced-btn" onclick="clearPhotoData()">ğŸ§¹æ¸…ç©ºè³‡æ–™</button>
        <button class="btn btn-red advanced-btn" onclick="openImportModal('student')">ğŸ§’åŒ¯å…¥æ–°ç”Ÿåå–®</button>
        <button class="btn btn-blue advanced-btn" onclick="openImportModal('teacher')">ğŸ‘¨â€ğŸ«åŒ¯å…¥å°å¸«åå–®</button>
        <button class="btn btn-orange advanced-btn" onclick="openPhotoFolder()">ğŸ“‚å¤§é ­ç…§è³‡æ–™å¤¾</button>
      </div>
      <button class="cancel-btn" onclick="hideAdvancedSettings()">âŒ é›¢é–‹è¨­å®š</button>
    </div>
  </div>

  <!-- æ¼‚æµ®æç¤ºè¨Šæ¯ -->
  <div id="floating-msg" class="msg"></div>

  <!-- é€šç”¨ç¢ºèª Modal (Yes/No) -->
  <div id="modal-mask" class="modal-mask">
    <div id="modal-dialog" class="modal-dialog">
      <div id="modal-message" style="font-size:28px; margin-bottom:30px; color:#a30000;"></div>
      <button id="modal-ok-btn" style="font-size:24px; background:#43a047; color:#fff; border:none; border-radius:10px; padding:8px 28px; margin-right:24px; cursor:pointer;">ç¢ºå®š</button>
      <button id="modal-cancel-btn" style="font-size:24px; background:#bdbdbd; color:#333; border:none; border-radius:10px; padding:8px 28px; cursor:pointer;">å–æ¶ˆ</button>
    </div>
  </div>

  <!-- ğŸ†• è²¼ä¸ŠåŒ¯å…¥ Modal (Textarea) -->
  <div id="paste-modal" class="modal-mask">
    <div id="paste-modal-dialog" class="modal-dialog">
      <h2 id="paste-modal-title" style="color:#1976d2; font-size:32px; font-weight:bold;">åŒ¯å…¥è³‡æ–™</h2>
      <div style="text-align:left; color:#555; margin-bottom:10px; font-size:18px; line-height: 1.5; background: #e3f2fd; padding: 10px; border-radius: 8px; flex-shrink: 0;">
        <strong>ğŸ“‹ ä½¿ç”¨èªªæ˜ï¼š</strong><br>
        1. è«‹åœ¨ Excel ä¸­é¸å–è³‡æ–™ç¯„åœ (å¿…é ˆåŒ…å«æ¨™é¡Œåˆ—)ï¼ŒæŒ‰ä¸‹ Ctrl+C è¤‡è£½ã€‚<br>
        2. åœ¨ä¸‹æ–¹æ¡†æ¡†å…§æŒ‰ä¸‹ Ctrl+V è²¼ä¸Šã€‚<br>
        3. ç³»çµ±å°‡è‡ªå‹•è­˜åˆ¥å¿…è¦æ¬„ä½ï¼š<br>
        <span id="paste-keywords" style="background:#fff; padding:2px 8px; border-radius:4px; color:#d32f2f; font-weight:bold; border: 1px solid #ffcdd2;"></span><br>
        <strong style="color: #d32f2f;">âš ï¸ æ³¨æ„ï¼šåŒ¯å…¥æ™‚å°‡æœƒè‡ªå‹•æ¸…ç©ºåŸæœ‰çš„è³‡æ–™è¡¨å…§å®¹ï¼</strong>
      </div>
      <textarea id="paste-textarea" placeholder="è«‹åœ¨æ­¤è²¼ä¸Š Excel è³‡æ–™..."></textarea>
      <div style="margin-top: 15px; flex-shrink: 0;">
        <button onclick="submitPasteImport()" style="font-size:24px; background:#43a047; color:#fff; border:none; border-radius:10px; padding:8px 28px; margin-right:24px; cursor:pointer;">
          <i class="fas fa-file-import"></i> ç¢ºå®šåŒ¯å…¥
        </button>
        <button onclick="closeImportModal()" style="font-size:24px; background:#bdbdbd; color:#333; border:none; border-radius:10px; padding:8px 28px; cursor:pointer;">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <script>
    // ---------------- UI å·¥å…·å‡½å¼ ----------------
    function showMessage(text, type = 'info', durationInSeconds = 3) {
      const msg = document.getElementById('floating-msg');
      msg.className = `msg msg-${type}`;
      msg.innerText = text;
      msg.style.display = 'block';
      setTimeout(() => { msg.style.display = 'none'; }, durationInSeconds * 1000);
    }

    let progressInterval;
    function showProgress(text = 'è™•ç†ä¸­') {
      const msg = document.getElementById('floating-msg');
      let percent = 10;
      msg.className = 'msg msg-progress';
      msg.innerText = `â³ ${text}...${percent}%`;
      msg.style.display = 'block';
      progressInterval = setInterval(() => {
        percent += 10;
        if (percent <= 90) msg.innerText = `â³ ${text}...${percent}%`;
        else clearInterval(progressInterval);
      }, 300);
    }

    function finishProgress(callback) {
      clearInterval(progressInterval);
      const msg = document.getElementById('floating-msg');
      msg.innerText = 'â³ å®Œæˆ...100%';
      setTimeout(() => {
        msg.style.display = 'none';
        if (callback) callback();
      }, 500);
    }

    // é€šç”¨ç¢ºèªå°è©±æ¡†
    function showConfirmModal(msg, onOk) {
      const mask = document.getElementById('modal-mask');
      document.getElementById('modal-message').innerText = msg;
      mask.style.display = 'block';

      const okBtn = document.getElementById('modal-ok-btn');
      const cancelBtn = document.getElementById('modal-cancel-btn');
      
      const newOk = okBtn.cloneNode(true);
      const newCancel = cancelBtn.cloneNode(true);
      okBtn.parentNode.replaceChild(newOk, okBtn);
      cancelBtn.parentNode.replaceChild(newCancel, cancelBtn);

      newOk.onclick = function() {
        mask.style.display = 'none';
        if (typeof onOk === 'function') onOk();
      };
      newCancel.onclick = function() {
        mask.style.display = 'none';
      };
    }

    function handleClear() {
      ['grade','class','seat','status','name','sid','repeat'].forEach(id => document.getElementById(id).value = '');
      document.getElementById('result-container').innerHTML = '';
      document.getElementById('stats-container').innerHTML = '';
      document.getElementById('advanced-settings').style.display = 'none';
      initSelects();
    }

    // ---------------- æ ¸å¿ƒåŠŸèƒ½é‚è¼¯ ----------------

    function handleUnsubmitted() {
      document.getElementById('result-container').innerHTML = '';
      document.getElementById('stats-container').innerHTML = '';
      showProgress('æŸ¥è©¢æœªä¸Šå‚³');
      
      callApi('getUnsubmitted')
        .then(data => {
          finishProgress(() => {
            if (data.length === 0) {
              showMessage('âš ï¸ æŸ¥ç„¡æœªä¸Šå‚³è³‡æ–™!', 'info', 3);
            } else {
              const html = `
                <table style="width:80%; margin:12px auto; box-shadow:0 0 10px rgba(255,193,7,0.3); border:2px solid #fbc02d;">
                  <thead style="background-color:#ffeb3b;">
                    <tr><th>ç­ç´š</th><th>åº§è™Ÿ</th><th>å§“å</th><th>å­¸è™Ÿ</th><th>ç¹³äº¤æƒ…å½¢</th></tr>
                  </thead>
                  <tbody>
                    ${data.map(r => `
                      <tr><td>${r.classNo}</td><td>${r.seatNo}</td><td>${r.name}</td><td>${r.sid}</td><td>${r.status}</td></tr>
                    `).join('')}
                  </tbody>
                </table>`;
              document.getElementById('result-container').innerHTML = html;
            }
          });
        });
    }

    let currentAllData = [];
    let currentPage = 1;
    const pageSize = 30;

    function handleQuery() {
      const filters = {
        grade: document.getElementById('grade').value,
        classNo: document.getElementById('class').value,
        seatNo: document.getElementById('seat').value,
        name: document.getElementById('name').value.trim(),
        sid: document.getElementById('sid').value.trim(),
        status: document.getElementById('status').value,
        repeat: document.getElementById('repeat').value
      };

      if (Object.values(filters).every(x => !x)) {
        showMessage('âŒ è«‹è¼¸å…¥æŸ¥è©¢æ¢ä»¶', 'error', 3);
        return;
      }

      document.getElementById('result-container').innerHTML = '';
      document.getElementById('stats-container').innerHTML = '';
      document.getElementById('advanced-settings').style.display = 'none';

      showProgress('æŸ¥è©¢ä¸­');

      callApi('query', filters)
        .then(allData => {
          finishProgress(() => {
            if (!allData || allData.length === 0) {
              showMessage('âš ï¸ æŸ¥ç„¡ä»»ä½•è³‡æ–™!', 'info', 3);
              return;
            }
            allData.sort((a, b) => a.grade - b.grade || a.classNo - b.classNo || a.seatNo - b.seatNo);
            currentAllData = allData;
            currentPage = 1;
            renderPage();
            showMessage('âœ… æŸ¥è©¢æˆåŠŸ', 'success', 2);
          });
        });
    }

    function renderPage() {
      const pageCount = Math.max(1, Math.ceil(currentAllData.length / pageSize));
      const start = (currentPage - 1) * pageSize;
      const data = currentAllData.slice(start, start + pageSize);
      const resultBox = document.getElementById('result-container');

      const pagerHtml = (pos) => `
        <div style="display:flex; align-items:center; justify-content:center; gap:12px; margin:12px 0;">
          <button onclick="changePage(1)" class="btn btn-blue" ${currentPage<=1?'disabled':''}>é¦–é </button>
          <button onclick="changePage(${currentPage-1})" class="btn btn-blue" ${currentPage<=1?'disabled':''}>ä¸Šä¸€é </button>
          <div style="font-size:18px; font-weight:600;">ç¬¬ ${currentPage} / ${pageCount} é ï½œå…± ${currentAllData.length} ç­†</div>
          <button onclick="changePage(${currentPage+1})" class="btn btn-blue" ${currentPage>=pageCount?'disabled':''}>ä¸‹ä¸€é </button>
          <button onclick="changePage(${pageCount})" class="btn btn-blue" ${currentPage>=pageCount?'disabled':''}>æœ«é </button>
        </div>`;

      const tableHtml = `
        <table border="1" style="width:100%; table-layout: fixed;">
          <thead>
            <tr>
              <th style="width:40px;">å¹´ç´š</th><th style="width:40px;">ç­ç´š</th><th style="width:40px;">åº§è™Ÿ</th>
              <th style="width:60px;">å§“å</th><th style="width:80px;">å­¸è™Ÿ</th>
              <th style="width:230px; word-break: break-all;">ç›¸ç‰‡ç¶²å€</th>
              <th style="width:200px;">ç›¸ç‰‡</th>
              <th style="width:160px;">è¨»å†Šçµ„è™•ç†</th>
              <th style="width:100px;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            ${data.map(r => `
              <tr data-uuid="${r.uuid}" data-orig-url="${r.photoUrl||''}" data-orig-status="${r.status||''}" data-orig-name="${r.name||''}">
                <td>${r.grade}</td><td>${r.classNo}</td><td>${r.seatNo}</td><td>${r.name}</td><td>${r.sid}</td>
                <td class="photo-url" style="word-break: break-all;">
                  ${r.photoUrl ? `<a href="${r.photoUrl}" target="_blank" style="color:blue;">${r.photoUrl}</a>` : ''}
                </td>
                <td class="photo-img" data-file-id="${extractDriveFileId(r.photoUrl)}">
                  <span class="loading-text">è¼‰å…¥ä¸­...</span>
                </td>
                <td class="status-cell"><span>${r.status || ''}</span></td>
                <td>
                  <div style="display:flex; flex-direction:column; gap:6px; align-items:center;">
                    <button class="modify-btn" onclick="editRow(this)">ä¿®æ”¹</button>
                    <button class="delete-btn" onclick="deleteRow(this)">åˆªé™¤</button>
                    <button class="cancel-btn" onclick="cancelEdit(this)" style="font-size:14px; padding:4px 10px;">å–æ¶ˆ</button>
                    <button class="btn btn-cyan" style="font-size:16px; padding:6px 12px; border-radius:10px;" onclick="refreshImage(this)">é‡åŒ¯</button>
                    <button class="btn btn-orange rename-btn" style="font-size:16px; padding:6px 12px; border-radius:10px;" onclick="startRename(this)">æ”¹å</button>
                  </div>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>`;

      resultBox.innerHTML = pagerHtml('top') + tableHtml + pagerHtml('bottom');
      loadImages();
    }

    function changePage(p) {
      currentPage = p;
      renderPage();
    }

    function extractDriveFileId(url) {
      if(!url) return null;
      const match = url.match(/\/d\/([a-zA-Z0-9_-]{25,})/);
      return match ? match[1] : null;
    }

    function loadImages() {
      document.querySelectorAll('.photo-img').forEach(td => {
        const fileId = td.getAttribute('data-file-id');
        if (fileId) {
          callApi('getImage', {fileId: fileId})
            .then(res => {
              if (res && res.url) {
                td.innerHTML = `
                  <div style="display:flex; flex-direction:column; align-items:center;">
                    <img src="${res.url}" style="max-height:160px; max-width:180px; object-fit:contain;">
                    <div style="font-size:16px; margin-top:4px; color:#555;">${res.name || ''}</div>
                  </div>`;
              } else {
                td.innerHTML = `<span style="color:red;">ç„¡æ³•é¡¯ç¤º</span>`;
              }
            });
        } else {
          td.innerHTML = `<span style="color:gray;">ç„¡æ³•é¡¯ç¤º</span>`;
        }
      });
    }

    function editRow(btn) {
      const row = btn.closest('tr');
      const photoCell = row.querySelector('.photo-url');
      const statusCell = row.querySelector('.status-cell');
      const uuid = row.dataset.uuid;

      if (btn.innerText === 'ä¿®æ”¹') {
        const currentPhoto = photoCell.innerText.trim();
        photoCell.innerHTML = `<input type="text" value="${currentPhoto}" style="width:210px;">`;
        
        const currentStatus = statusCell.innerText.trim();
        const mainStatus = currentStatus.includes("ä¸åˆæ ¼") ? "ä¸åˆæ ¼ï¼Œé‡æ–°ä¸Šå‚³" : currentStatus;
        const reason = currentStatus.includes("ï¼š") ? currentStatus.split("ï¼š")[1] : "";
        
        statusCell.innerHTML = `
          <select onchange="this.nextElementSibling.style.display=(this.value=='ä¸åˆæ ¼ï¼Œé‡æ–°ä¸Šå‚³'?'block':'none')" style="width:150px;">
            <option ${mainStatus=='å·²ä¸Šå‚³ï¼Œå¯©æ ¸ä¸­'?'selected':''}>å·²ä¸Šå‚³ï¼Œå¯©æ ¸ä¸­</option>
            <option ${mainStatus=='å·²ä¸Šå‚³ï¼Œåˆæ ¼'?'selected':''}>å·²ä¸Šå‚³ï¼Œåˆæ ¼</option>
            <option ${mainStatus=='ä¸åˆæ ¼ï¼Œé‡æ–°ä¸Šå‚³'?'selected':''}>ä¸åˆæ ¼ï¼Œé‡æ–°ä¸Šå‚³</option>
          </select>
          <div style="display:${mainStatus=='ä¸åˆæ ¼ï¼Œé‡æ–°ä¸Šå‚³'?'block':'none'}; margin-top:5px;">
            <input type="text" value="${reason}" placeholder="åŸå› " style="width:140px;">
          </div>`;
          
        btn.innerText = 'ç¢ºå®š';
        btn.style.background = '#4CAF50';
        btn.style.color = 'white';
      } else {
        const newPhoto = photoCell.querySelector('input').value.trim();
        const select = statusCell.querySelector('select');
        const reasonInput = statusCell.querySelector('input');
        let newStatus = select.value;
        if (newStatus === 'ä¸åˆæ ¼ï¼Œé‡æ–°ä¸Šå‚³' && reasonInput.value.trim()) {
          newStatus += "ï¼š" + reasonInput.value.trim();
        }

        showProgress('æ›´æ–°ä¸­');
        callApi('update', {uuid, newPhotoUrl: newPhoto, newStatus: newStatus})
          .then(res => {
            finishProgress(() => {
              if(res) {
                showMessage('âœ… è³‡æ–™å·²æ›´æ–°', 'success');
                row.dataset.origUrl = newPhoto;
                row.dataset.origStatus = newStatus;
                
                photoCell.innerHTML = newPhoto ? `<a href="${newPhoto}" target="_blank" style="color:blue;">${newPhoto}</a>` : '';
                statusCell.innerHTML = `<span>${newStatus}</span>`;
                btn.innerText = 'ä¿®æ”¹';
                btn.style.background = '#fdd835';
                btn.style.color = 'black';
                
                const imgTd = row.querySelector('.photo-img');
                imgTd.setAttribute('data-file-id', extractDriveFileId(newPhoto));
                loadImages();
              } else {
                showMessage('âŒ æ›´æ–°å¤±æ•—', 'error');
              }
            });
          });
      }
    }

    function cancelEdit(btn) {
      const row = btn.closest('tr');
      const modifyBtn = row.querySelector('.modify-btn');
      
      const origUrl = row.dataset.origUrl;
      const origStatus = row.dataset.origStatus;
      
      row.querySelector('.photo-url').innerHTML = origUrl ? `<a href="${origUrl}" target="_blank" style="color:blue;">${origUrl}</a>` : '';
      row.querySelector('.status-cell').innerHTML = `<span>${origStatus}</span>`;
      
      if (modifyBtn.innerText === 'ç¢ºå®š') {
        modifyBtn.innerText = 'ä¿®æ”¹';
        modifyBtn.style.background = '#fdd835';
        modifyBtn.style.color = 'black';
      }
      
      const renameBtn = row.querySelector('.rename-btn');
      const nameDiv = row.querySelector('.photo-img div div');
      if (renameBtn && renameBtn.innerText === 'ç¢ºå®š' && nameDiv && nameDiv.dataset.origName) {
        nameDiv.innerHTML = nameDiv.dataset.origName;
        renameBtn.innerText = "æ”¹å";
        renameBtn.classList.remove("btn-green");
        renameBtn.classList.add("btn-orange");
        renameBtn.onclick = function() { startRename(this); };
      }
    }

    // âœ… åˆªé™¤åˆ—å¾Œè§¸ç™¼æ›´æ–°ç‹€æ…‹ç‡ˆ
    function deleteRow(btn) {
      const row = btn.closest('tr');
      const uuid = row.dataset.uuid;
      const name = row.children[3].innerText;
      
      showConfirmModal(`âš ï¸ ç¢ºå®šåˆªé™¤ ${name} çš„è³‡æ–™ï¼Ÿ`, () => {
        showProgress('åˆªé™¤ä¸­');
        callApi('delete', {uuid: uuid}).then(res => {
          finishProgress(() => {
            if(res) {
              showMessage('âœ… å·²åˆªé™¤', 'success');
              row.remove();
              updateFolderStatus(); // åˆªé™¤å¾Œç«‹å³æ›´æ–°è³‡æ–™å¤¾ç‹€æ…‹
            } else {
              showMessage('âŒ åˆªé™¤å¤±æ•—', 'error');
            }
          });
        });
      });
    }

    function refreshImage(btn) {
      const row = btn.closest('tr');
      const imgTd = row.querySelector('.photo-img');
      const fileId = extractDriveFileId(row.querySelector('.photo-url a')?.href);
      
      if (!fileId) { showMessage('ç„¡æœ‰æ•ˆåœ–ç‰‡é€£çµ', 'error'); return; }
      
      imgTd.innerHTML = '<span class="loading-text">é‡æ–°è¼‰å…¥...</span>';
      callApi('getImage', {fileId}).then(res => {
        if (res && res.url) {
           imgTd.innerHTML = `
              <div style="display:flex; flex-direction:column; align-items:center;">
                <img src="${res.url}" style="max-height:160px; max-width:180px; object-fit:contain;">
                <div style="font-size:16px; margin-top:4px; color:#555;">${res.name || ''}</div>
              </div>`;
        } else {
           imgTd.innerHTML = '<span style="color:red">ç„¡æ³•é¡¯ç¤º</span>';
        }
      });
    }

    function startRename(btn) {
      const row = btn.closest('tr');
      const imgCell = row.querySelector('.photo-img');
      const nameDiv = imgCell.querySelector('div:last-child');
      
      if (!nameDiv) { showMessage("æ‰¾ä¸åˆ°åœ–ç‰‡æˆ–æª”å", "error"); return; }
      
      const originalName = nameDiv.innerText.trim();
      nameDiv.dataset.origName = originalName; 
      nameDiv.innerHTML = `<input type="text" value="${originalName}" style="width:140px;">`;
      
      btn.innerText = "ç¢ºå®š";
      btn.classList.remove("btn-orange");
      btn.classList.add("btn-green");
      btn.onclick = function() { confirmRename(this); };
    }

    function confirmRename(btn) {
      const row = btn.closest('tr');
      const imgCell = row.querySelector('.photo-img');
      const input = imgCell.querySelector('input');
      const newName = input.value.trim();
      const fileId = extractDriveFileId(row.querySelector('.photo-url a')?.href);

      if (!fileId || !newName) { showMessage("åƒæ•¸éŒ¯èª¤", "error"); return; }

      showProgress('æ”¹åä¸­');
      callApi('renameFile', {fileId, newName}).then(res => {
        finishProgress(() => {
           if(res === 'OK') {
             showMessage("âœ… æ”¹åæˆåŠŸ", "success");
             refreshImage(btn);
             btn.innerText = "æ”¹å";
             btn.classList.remove("btn-green");
             btn.classList.add("btn-orange");
             btn.onclick = function() { startRename(this); };
           } else {
             showMessage("âŒ " + res, "error");
           }
        });
      });
    }

    function showStatsTable() {
      document.getElementById("result-container").innerHTML = '';
      showMessage('â³ è¼‰å…¥ç­ç´šçµ±è¨ˆè¡¨...', 'info');
      callApi('getStatsTable').then(html => {
        document.getElementById("stats-container").innerHTML = html;
        showMessage('âœ… çµ±è¨ˆè¡¨è¼‰å…¥å®Œæˆ', 'success');
      });
    }

    function updateSummaryStats() {
      callApi('getSummaryStats').then(rows => {
        const statsBox = document.getElementById("summary-content");
        const oldList = statsBox.querySelector("ul"); if (oldList) oldList.remove();
        const loading = statsBox.querySelector("div"); if (loading) loading.remove();
        
        if (!rows || rows.length === 0) {
           statsBox.innerHTML += '<div>âŒ ç„¡è³‡æ–™</div>'; return;
        }
        
        const ul = document.createElement("ul");
        rows.forEach(row => {
          const li = document.createElement("li");
          li.innerHTML = `ğŸ”¹ <strong>${row[0]}</strong>ï¼š${row[1]}`;
          ul.appendChild(li);
        });
        statsBox.appendChild(ul);
      }).catch(e => console.log("çµ±è¨ˆæ›´æ–°å¤±æ•—(å¯èƒ½ç¶²è·¯å•é¡Œ)"));
    }

    // ğŸ†• æª¢æŸ¥è³‡æ–™å¤¾ç‹€æ…‹èˆ‡æª”æ¡ˆæ•¸é‡
    function updateFolderStatus() {
      callApi('checkFolderStatus').then(res => {
        const light = document.getElementById('folder-light');
        if (res && res.exists) {
          light.innerHTML = `<span style="color:#2e7d32; background:#c8e6c9; padding:4px 12px; border-radius:20px;">ğŸŸ¢ æ­£å¸¸ (å…± ${res.count} å¼µç…§ç‰‡)</span>`;
        } else {
          light.innerHTML = `<span style="color:#c62828; background:#ffcdd2; padding:4px 12px; border-radius:20px;">ğŸ”´ éºå¤±æˆ–è¢«åˆªé™¤ï¼</span>`;
        }
      }).catch(e => {
        document.getElementById('folder-light').innerHTML = `<span style="color:#ef6c00; background:#ffe0b2; padding:4px 12px; border-radius:20px;">ğŸŸ¡ ç„¡æ³•æª¢æŸ¥</span>`;
      });
    }

    function showAdvancedSettings() {
      document.getElementById("result-container").innerHTML = '';
      document.getElementById("stats-container").innerHTML = '';
      document.getElementById("advanced-settings").style.display = 'block';
    }
    function hideAdvancedSettings() {
      document.getElementById('advanced-settings').style.display = 'none';
    }
    
    function openPhotoFolder() {
      window.open('https://drive.google.com/drive/u/0/folders/1PXYSIsQK61MxsoyZWoa8zwvhlw2oMgZu', '_blank');
    }
    
    // âœ… æ¸…ç©ºè³‡æ–™å¾Œè§¸ç™¼æ›´æ–°ç‹€æ…‹ç‡ˆ
    function clearPhotoData() {
      showConfirmModal("âš ï¸ ç¢ºå®šæ¸…ç©ºæ‰€æœ‰å¤§é ­ç…§è³‡æ–™ï¼Ÿ", () => {
         showProgress('æ¸…ç©ºä¸­');
         callApi('clearData').then(() => {
           finishProgress(() => {
             showMessage('âœ… å·²æ¸…ç©º', 'success');
             updateFolderStatus(); // æ¸…ç©ºå¾Œç«‹å³æ›´æ–°è³‡æ–™å¤¾ç‹€æ…‹
           });
         });
      });
    }

    // ------------------- ğŸ†• è²¼ä¸ŠåŒ¯å…¥é‚è¼¯ -------------------

    let currentImportType = ''; // 'student' or 'teacher'

    function openImportModal(type) {
      currentImportType = type;
      const title = type === 'student' ? 'åŒ¯å…¥æ–°ç”Ÿåå–®' : 'åŒ¯å…¥å°å¸«åå–®';
      // é—œéµå­—
      const keywords = type === 'student' 
        ? 'ç­ç´šã€åº§è™Ÿã€èº«åˆ†è­‰å¾Œå››ç¢¼ã€å§“åã€å­¸è™Ÿ' 
        : 'ç­ç´šã€å°å¸«';
        
      document.getElementById('paste-modal-title').innerText = title;
      document.getElementById('paste-keywords').innerText = keywords;
      document.getElementById('paste-textarea').value = ''; // æ¸…ç©º
      document.getElementById('paste-modal').style.display = 'block';
    }

    function closeImportModal() {
      document.getElementById('paste-modal').style.display = 'none';
    }

    function submitPasteImport() {
      const text = document.getElementById('paste-textarea').value.trim();
      if (!text) {
        showMessage('âŒ å…§å®¹ç‚ºç©ºï¼', 'error');
        return;
      }

      // è§£æ Excel è¤‡è£½çš„å…§å®¹ (Tab åˆ†éš”)
      const rows = text.split(/\r?\n/);
      if (rows.length < 2) {
        showMessage('âŒ è³‡æ–™è¡Œæ•¸ä¸è¶³ (è‡³å°‘éœ€åŒ…å«æ¨™é¡Œèˆ‡ä¸€åˆ—è³‡æ–™)', 'error', 4);
        return;
      }

      // è§£ææ¨™é¡Œåˆ— (ç¬¬ä¸€è¡Œ)
      const headerLine = rows[0].split('\t').map(h => h.trim());
      
      // å®šç¾©å¿…è¦æ¬„ä½
      const requiredHeaders = currentImportType === 'student'
        ? ['ç­ç´š', 'åº§è™Ÿ', 'èº«åˆ†è­‰å¾Œå››ç¢¼', 'å§“å', 'å­¸è™Ÿ']
        : ['ç­ç´š', 'å°å¸«'];

      // æª¢æŸ¥æ¬„ä½æ˜¯å¦å­˜åœ¨
      const missing = requiredHeaders.filter(h => !headerLine.includes(h));
      if (missing.length > 0) {
        showMessage(`âŒ ç¼ºå°‘æ¬„ä½ï¼š${missing.join(', ')}`, 'error', 5);
        return;
      }

      // å»ºç«‹ç´¢å¼•å°æ‡‰ Map (æ‰¾å‡ºæ¯å€‹æ¨™é¡Œåœ¨ç¬¬å¹¾æ¬„)
      const colIndices = requiredHeaders.map(h => headerLine.indexOf(h));

      // è§£æè³‡æ–™åˆ— (å¾ç¬¬äºŒè¡Œé–‹å§‹)
      const listData = [];
      for (let i = 1; i < rows.length; i++) {
        const cols = rows[i].split('\t');
        
        // ç°¡å–®éæ¿¾ç©ºè¡Œ
        if (cols.length < colIndices.length && cols.every(c => !c.trim())) continue;
        
        // ä¾ç…§éœ€è¦çš„é †åºæå–è³‡æ–™
        const rowData = colIndices.map(idx => (cols[idx] || '').trim());
        
        // å†æ¬¡æª¢æŸ¥æ˜¯å¦æœ‰ç©ºå€¼è³‡æ–™åˆ— (å…¨ç©ºå‰‡è·³é)
        if (rowData.every(c => c === '')) continue;
        
        listData.push(rowData);
      }

      if (listData.length === 0) {
        showMessage('âŒ æ²’æœ‰æœ‰æ•ˆçš„è³‡æ–™åˆ—ï¼', 'error');
        return;
      }

      // é€å‡ºè³‡æ–™åˆ°å¾Œç«¯
      showProgress('åŒ¯å…¥è³‡æ–™åº«');
      const apiAction = currentImportType === 'student' ? 'importList' : 'importTeacher';

      callApi(apiAction, { listData }).then(res => {
        finishProgress(() => {
          if (res && res.success) {
            showMessage('âœ… åŒ¯å…¥æˆåŠŸï¼', 'success');
            closeImportModal();
          } else {
            showMessage('âŒ åŒ¯å…¥å¤±æ•—ï¼š' + (res.message || 'æœªçŸ¥åŸå› '), 'error');
          }
        });
      });
    }

    // åˆå§‹åŒ–ä¸‹æ‹‰é¸å–®
    function initSelects() {
      const cls = document.getElementById('class');
      const seat = document.getElementById('seat');
      cls.innerHTML = '<option value=""></option>' + Array.from({length:17}, (_,i) =>
        `<option value="${String(i+1).padStart(2,'0')}">${String(i+1).padStart(2,'0')}</option>`).join('');
      seat.innerHTML = '<option value=""></option>' + Array.from({length:30}, (_,i) =>
        `<option value="${String(i+1).padStart(2,'0')}">${String(i+1).padStart(2,'0')}</option>`).join('');
    }

    window.onload = () => {
      initSelects();
      
      // åˆå§‹åŠ è¼‰çµ±è¨ˆè³‡æ–™èˆ‡è³‡æ–™å¤¾ç‹€æ…‹
      updateSummaryStats();
      updateFolderStatus(); 
      
      // è¨­å®šå®šæ™‚å™¨
      setInterval(updateSummaryStats, 10000); // 10ç§’æ›´æ–°ä¸€æ¬¡
      setInterval(updateFolderStatus, 30000); // 30ç§’æ›´æ–°ä¸€æ¬¡è³‡æ–™å¤¾ç‹€æ…‹
    };
  </script>
</body>
</html>